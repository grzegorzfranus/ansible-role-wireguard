---
# =============================================================================
# Ansible Role: WireGuard Mesh - Cryptographic Key Management
# =============================================================================
# This file contains tasks for generating and managing WireGuard cryptographic
# keys. It handles private/public key pair generation, fact storage, and secure
# file permissions for mesh network configuration.
#
# Flow:
# 1. Key Directory Management
# 2. Private Key Generation
# 3. Public Key Derivation
# 4. Pre-Shared Key Management (PSK) - Enhanced Security
# 5. Fact Storage and Registration
# =============================================================================

# -----------------------------------------------------------------------------
# 1. Key Directory Management
# -----------------------------------------------------------------------------
- name: 🔍 WireGuard | keys | Check if private key exists
  become: true
  ansible.builtin.stat:
    path: "{{ wireguard_config_dir }}/privatekey"
  register: wireguard_private_key_stat

# -----------------------------------------------------------------------------
# 1.a Guard: fail if keys are required but generation is disabled
# -----------------------------------------------------------------------------
- name: 🧪 WireGuard | keys | Validate key presence when generation disabled
  ansible.builtin.fail:
    msg: "❌ Private key not found at {{ wireguard_config_dir }}/privatekey and wireguard_generate_keys is false. Generate keys manually or enable wireguard_generate_keys."
  when: >
    (not wireguard_generate_keys | bool) and
    (not wireguard_private_key_stat.stat.exists)

# -----------------------------------------------------------------------------
# 2. Private Key Generation
# -----------------------------------------------------------------------------
- name: WireGuard | keys | Generate private key
  become: true
  ansible.builtin.shell: |
    wg genkey > {{ wireguard_config_dir }}/privatekey
  when: >
    wireguard_generate_keys | bool and
    not wireguard_private_key_stat.stat.exists
  register: wireguard_private_key_generated
  no_log: true
  args:
    creates: "{{ wireguard_config_dir }}/privatekey"

- name: WireGuard | keys | Set private key permissions
  become: true
  ansible.builtin.file:
    path: "{{ wireguard_config_dir }}/privatekey"
    mode: "{{ wireguard_private_key_permissions }}"
    owner: root
    group: root

# -----------------------------------------------------------------------------
# 3. Public Key Derivation
# -----------------------------------------------------------------------------
- name: WireGuard | keys | Generate public key from private key
  become: true
  ansible.builtin.shell: |
    wg pubkey < {{ wireguard_config_dir }}/privatekey > {{ wireguard_config_dir }}/publickey
  when: >
    wireguard_private_key_generated is changed or
    not wireguard_private_key_stat.stat.exists
  args:
    creates: "{{ wireguard_config_dir }}/publickey"

- name: WireGuard | keys | Set public key permissions
  become: true
  ansible.builtin.file:
    path: "{{ wireguard_config_dir }}/publickey"
    mode: "{{ wireguard_public_key_permissions }}"
    owner: root
    group: root

# -----------------------------------------------------------------------------
# 4. Pre-Shared Key Management (PSK)
# -----------------------------------------------------------------------------
# NOTE: PSK is now managed cluster-wide at runtime in tasks/psk.yml.
# This role no longer persists PSK to files or host facts.

# -----------------------------------------------------------------------------
# 5. Fact Storage and Registration
# -----------------------------------------------------------------------------
- name: WireGuard | keys | Read private key
  become: true
  ansible.builtin.slurp:
    src: "{{ wireguard_config_dir }}/privatekey"
  register: wireguard_private_key_content
  no_log: true

- name: WireGuard | keys | Read public key
  become: true
  ansible.builtin.slurp:
    src: "{{ wireguard_config_dir }}/publickey"
  register: wireguard_public_key_content

- name: WireGuard | keys | Store keys in facts
  ansible.builtin.set_fact:
    wireguard_local_private_key: "{{ wireguard_private_key_content.content | b64decode | trim }}"
    wireguard_local_public_key: "{{ wireguard_public_key_content.content | b64decode | trim }}"
  no_log: true

- name: WireGuard | keys | Create host facts directory
  become: true
  ansible.builtin.file:
    path: /etc/ansible/facts.d
    state: directory
    mode: '0755'

- name: WireGuard | keys | Store keys in host facts
  become: true
  ansible.builtin.copy:
    content: |
      {
        "wireguard_public_key": "{{ wireguard_local_public_key }}"
      }
    dest: /etc/ansible/facts.d/wireguard.fact
    mode: '0600'
  no_log: true

- name: WireGuard | keys | Refresh ansible facts
  become: true
  ansible.builtin.setup:
    filter: "ansible_local"

- name: ✅ WireGuard | keys | Display key generation status
  ansible.builtin.debug:
    msg: "✅ WireGuard keys managed for host {{ inventory_hostname }}"
