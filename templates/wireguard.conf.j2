#jinja2: trim_blocks: True, lstrip_blocks: True
# =============================================================================
# WireGuard Configuration - {{ inventory_hostname }}
# =============================================================================
# Generated by Ansible role: wireguard
# Server IP: {{ wireguard_server_ip }}/24
# Interface: {{ wireguard_interface }}
# =============================================================================

[Interface]
# Server private key
PrivateKey = {{ wireguard_local_private_key }}

# Server IP address in the mesh network
Address = {{ wireguard_server_ip }}/24

# UDP port for WireGuard to listen on
ListenPort = {{ wireguard_port }}

# MTU for the interface
{% if wireguard_mtu is defined and wireguard_mtu > 0 %}
MTU = {{ wireguard_mtu }}
{% endif %}

# DNS servers (optional)
{% if wireguard_configure_dns | bool and wireguard_dns_servers | length > 0 %}
DNS = {{ wireguard_dns_servers | join(', ') }}
{% endif %}

# =============================================================================
# Mesh Peer Configurations
# =============================================================================
{% for peer_host in groups[wireguard_inventory_group] %}
{% if peer_host != inventory_hostname %}
{% set peer_ip = wireguard_network_prefix + '.' + (groups[wireguard_inventory_group].index(peer_host) + 1) | string %}
{% set peer_public_ip = (hostvars[peer_host]['wireguard_endpoint'] if (hostvars[peer_host].get('wireguard_endpoint') and (hostvars[peer_host]['wireguard_endpoint'] | string | length > 0)) else hostvars[peer_host]['ansible_default_ipv4']['address']) %}
{% set peer_public_key = hostvars[peer_host]['ansible_local']['wireguard']['wireguard_public_key'] %}

# Peer: {{ peer_host }}
[Peer]
PublicKey = {{ peer_public_key }}
{% if wireguard_enable_psk | bool %}
PresharedKey = {{ hostvars[peer_host]['ansible_local']['wireguard']['wireguard_psk'] }}
{% endif %}
Endpoint = {{ peer_public_ip }}:{{ wireguard_port }}
AllowedIPs = {{ peer_ip }}/32
PersistentKeepalive = {{ wireguard_persistent_keepalive }}

{% endif %}
{% endfor %}
